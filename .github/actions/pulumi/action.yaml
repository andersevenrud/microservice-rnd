name: Set up pulumi stack
inputs:
  version:
    required: true
    type: string
  token:
    required: true
    type: string
  passphrase:
    required: false
    type: string
  config:
    required: true
    type: string
runs:
  using: "composite"
  steps:
    - name: pulumi stack
      run: |
        mkdir -p configs
        echo "${{ inputs.config }}" > configs/Pulumi.vultr.yaml
        curl -fsSL https://get.pulumi.com | sh
        pulumi stack select vultr
        pulumi config set version ${{ inputs.version }}
        pulumi config set sha ${GITHUB_SHA::6}
      working-directory: ./deploy/pulumi
      shell: bash
      env:
        PULUMI_ACCESS_TOKEN: ${{ inputs.token }}
        PULUMI_CONFIG_PASSPHRASE: ${{ inputs.passphrase }}
