name: Release Deployment
env:
  PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: false
        default: latest
        description: Version number
jobs:
  api:
    if: github.event.inputs.version != 'latest'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: ./.github/actions/publisher
        with:
          package_name: api
          token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ github.event.inputs.version }}
  app:
    if: github.event.inputs.version != 'latest'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: ./.github/actions/publisher
        with:
          package_name: app
          token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ github.event.inputs.version }}
  cli:
    if: github.event.inputs.version != 'latest'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: ./.github/actions/publisher
        with:
          package_name: cli
          token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ github.event.inputs.version }}
  mailer:
    if: github.event.inputs.version != 'latest'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: ./.github/actions/publisher
        with:
          package_name: mailer
          token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ github.event.inputs.version }}
  runner:
    if: github.event.inputs.version != 'latest'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: ./.github/actions/publisher
        with:
          package_name: runner
          token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ github.event.inputs.version }}
  deploy:
    if: ${{ always() && (contains(needs.*.result, 'success') || contains(needs.*.result, 'skipped')) }}
    runs-on: ubuntu-latest
    needs: ['api', 'app', 'cli', 'mailer', 'runner']
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
          cache-dependency-path: deploy/pulumi/package-lock.json
      - run: npm ci
        working-directory: ./deploy/pulumi
      - name: pulumi stack
        run: |
          mkdir -p configs
          echo "${{ secrets.PULUMI_CONFIG }}" > configs/Pulumi.vultr.yaml
          curl -fsSL https://get.pulumi.com | sh
          pulumi stack select vultr
          pulumi config set version ${{ github.event.inputs.version }}
          pulumi config set sha ${GITHUB_SHA::6}
        working-directory: ./deploy/pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      - uses: pulumi/actions@v3
        with:
          command: up
          stack-name: vultr
          work-dir: ./deploy/pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
